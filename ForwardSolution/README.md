#消息转发方案

由于在数据传输过程中可能会出现收发双方都无法获取到公网IP，只能使用局域网的情况，此时就需要通过中间服务器来转发消息了。ForwardSolution就实现了这种方式。

##【关于程序】

1. sender中是发送端程序。

2. recver中是接收端程序。

3. tserver中是数据转发服务器。

4. SQLs文件夹中包含了使用触发器来处理没有identity字段的表的同步使用的创建备份表、创建insert触发器、插入已有数据到备份表的SQL语句的栗子，详见关于运作方式说明。

##【关于运作方式】

- sender会使用LastID、LastIDPlus中记录的identity字段名和最后同步的id值来判断本地数据库是否有新数据，有则查询出，每次最多查出50条记录，然后将数据转化成字符串（JSON格式）发送到tserver，由tserver转发到recver。

- recver收到转发过来的数据后将其最大ID值与本地维持的LastID值比较，大于本地值则将数据更新到本地表，并给sender反馈。

- sender每隔一定时间（同步周期，可以设置，默认为5s）将所有表检测一次。

- sender端对每个表都设置了退避时间，即如果某表某次查询后发现没有新数据，则下次等2个周期后再查询，再没有则再加倍，到超过16个周期后重置。所以对于数据不常变化的表最多可能等16个时间周期后才会被检测到然后传输给recver。

- 对于没有identity字段的表，采取使用insert触发器，将插入的数据记录到另一个结构类似只是多了一个identity字段的备份表中。SQLs中有几个触发器的栗子。__注意：备份表的名字必须是trigger4*<表名>*的形式，表中除了identity字段，其它字段名字和类型必须与原表完全一致。__

##【关于使用】

- sender和recver启动时都会加载配置文件*Config.ini*，如果此配置文件不存在或者里面某些项有错误，均会使用默认配置。使用默认配置必然会出现各种错误。可以在程序中更改配置，然后点保存配置保存。或者可以手动更改（LastID必须手动改）。关于配置文件详见下。

- 程序会自动保存日志信息，对于较大日志文件（大于10MB）会自动进行归档，为了日后查询错误方便，请不要手动删除日志文件。

- 除非手动点击停止，否则因为出现错误而导致同步失败的情况（如接收数据格式错误，读取数据失败，网络断开等）都会自动关闭连接、停止同步，然后自动重启。尤其是无法连接网络的情况，此时会无限自动重启（还是可以手动关掉滴）。

- 目前能想到的情况都已经做好了对应处理，其它没想到的必然会出现错误然后程序退出导致无法同步。网络通讯十分复杂、十分不可靠，无线网络更是如此，所以请留个心眼，隔一段时间检查一下。

##【关于配置文件】

- 配置文件里包含DBConnection、TCPServer、LastID几个section，sender比recver多了LastIDPlus、SyncConfig两个section。关于每个section里面各个ident的详细作用，配置文件中已经做了详细说明，可以打开查看。

- recver配置文件中LastID中的表应该包含sender配置文件中LastID和LastIDPlus中的所有表，只能比sender多绝对不能比sender少！！（虽然少了会自动添加，但如果是被注释掉就会导致信息丢失、数据重复传输了。）

- 总之，在不知道那一项配置是什么作用的时候，不要随便乱改，尤其是在ID部分。

##【其它建议】

1. **如果一开始在sender端数据库中就有数据，建议将直接将数据备份到recve**r，而不是采用使用此程序慢慢传的方式。尤其是有某个表有大量数据的时候，因为一个周期一个表最多只传50条记录，按默认周期5s来算，一分钟600，十分钟6000……

2. 表数目大时同步周期也应该长，建议同步周期不小于表数目的1/20，单位秒。如果表数目已经上千了，同步周期太长不说，写个配置文件都得累死，**建议放弃同步**！！！

3. 实际上应该会有很多表的数据是固定的，以后永远不会再改变，此时可以将 LastID 和LastIDPlus 部分的那些**不会改变的表的行注释掉，可以加快效率，减少内存占用。**
